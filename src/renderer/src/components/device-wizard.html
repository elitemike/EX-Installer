<template>
    <!-- This template is rendered inside the native <dialog> element by @aurelia/dialog.
         No backdrop/overlay wrapper needed — the dialog plugin provides that. -->
    <div class="bg-gray-900 border border-white/10 rounded-2xl shadow-2xl" style="width: 540px;">

        <!-- Header -->
        <div class="flex items-center justify-between px-6 py-4 border-b border-white/10">
            <div>
                <div class="flex items-center gap-2">
                    <h2 class="text-white font-semibold text-base">Setup New Device</h2>
                    <span if.bind="isMock"
                        class="px-1.5 py-0.5 rounded text-xs font-bold bg-amber-500/20 text-amber-400 border border-amber-500/30">DEV
                        MOCK</span>
                </div>
                <p class="text-gray-400 text-xs mt-0.5">${STEP_LABELS[step].label}</p>
            </div>
            <button click.trigger="cancel()"
                class="w-8 h-8 flex items-center justify-center rounded-lg text-gray-400 hover:text-white hover:bg-white/10 transition-colors">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>

        <!-- Syncfusion Stepper -->
        <div style="margin:10px 10px;">


            <nav ref="stepperContainer">
            </nav>

            <!-- Step content -->
            <div class="px-6 py-5 overflow-y-auto" style="height: 20rem;">

                <!-- ─── Step 0: CLI ─────────────────────────────────────── -->
                <div if.bind="step === 0" class="space-y-4">
                    <p class="text-gray-300 text-sm">
                        EX-Installer uses the Arduino CLI to compile and upload firmware.
                        It will be downloaded to your home folder and used automatically.
                    </p>

                    <div if.bind="cliInstalled"
                        class="flex items-center gap-3 bg-green-900/30 border border-green-500/30 rounded-xl p-4">
                        <svg class="w-5 h-5 text-green-400 flex-shrink-0" fill="none" stroke="currentColor"
                            viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                        <div>
                            <p class="text-green-300 font-medium text-sm">Arduino CLI is installed</p>
                            <p class="text-green-400/60 text-xs">Version: ${cliVersion}</p>
                        </div>
                    </div>

                    <div if.bind="!cliInstalled && !cliInstalling" class="space-y-4">
                        <div class="bg-amber-900/30 border border-amber-500/30 rounded-xl p-4 text-sm text-amber-300">
                            Arduino CLI is not installed. Click below to download and install it automatically.
                        </div>
                        <button click.trigger="installCli()"
                            class="w-full py-2.5 bg-blue-600 hover:bg-blue-500 rounded-lg text-white text-sm font-semibold transition-colors">
                            Install Arduino CLI
                        </button>
                    </div>

                    <div if.bind="cliInstalling" class="space-y-3">
                        <p class="text-blue-300 text-sm">${cliStatus}</p>
                        <div class="bg-gray-800 rounded-full h-2 overflow-hidden">
                            <div class="h-full bg-blue-500 rounded-full transition-all" css="width: ${cliProgress}%">
                            </div>
                        </div>
                    </div>

                    <div if.bind="cliError"
                        class="bg-red-900/30 border border-red-500/30 rounded-xl p-3 text-red-300 text-sm">${cliError}
                    </div>
                </div>

                <!-- ─── Step 1: Device ──────────────────────────────────── -->
                <div if.bind="step === 1" class="space-y-4">
                    <div class="flex items-center justify-between">
                        <p class="text-gray-300 text-sm">Select the connected Arduino-compatible device.</p>
                        <button click.trigger="scanDevices()" disabled.bind="scanning"
                            class="px-3 py-1.5 text-xs bg-white/10 hover:bg-white/20 border border-white/10 rounded-lg text-white transition-colors disabled:opacity-50">
                            ${scanning ? 'Scanning...' : '↻ Rescan'}
                        </button>
                    </div>

                    <div if.bind="boards.length > 0" class="space-y-2">
                        <button repeat.for="board of boards" click.trigger="selectedBoard = board"
                            class="w-full text-left border rounded-xl p-3.5 transition-all" class.bind="selectedBoard === board
                            ? 'border-blue-500 bg-blue-950/50'
                            : 'border-white/10 bg-white/5 hover:border-white/20 hover:bg-white/10'">
                            <div class="flex items-center gap-3">
                                <div class="w-2 h-2 rounded-full flex-shrink-0"
                                    class.bind="selectedBoard === board ? 'bg-blue-400' : 'bg-gray-600'"></div>
                                <div class="min-w-0">
                                    <p class="text-white text-sm font-medium truncate">${board.name}</p>
                                    <p class="text-gray-400 text-xs mt-0.5">
                                        ${board.port}<span if.bind="board.fqbn"> &middot; ${board.fqbn}</span>
                                    </p>
                                </div>
                            </div>
                        </button>
                    </div>

                    <div if.bind="boards.length === 0 && !scanning"
                        class="bg-amber-900/20 border border-amber-500/20 rounded-xl p-4 text-amber-300 text-sm">
                        No devices detected. Make sure your board is plugged in via USB and try Rescan.
                    </div>
                    <div if.bind="scanError"
                        class="bg-red-900/30 border border-red-500/30 rounded-xl p-3 text-red-300 text-sm">${scanError}
                    </div>
                </div>

                <!-- ─── Step 2: Product ─────────────────────────────────── -->
                <div if.bind="step === 2" class="space-y-3">
                    <p class="text-gray-300 text-sm">Choose the DCC-EX software product to install.</p>

                    <button repeat.for="product of products" disabled.bind="!isDeviceSupported(product.key)"
                        click.trigger="selectedProduct = product.key"
                        class="w-full text-left border rounded-xl p-4 transition-all disabled:opacity-40 disabled:cursor-not-allowed"
                        class.bind="selectedProduct === product.key
                        ? 'border-blue-500 bg-blue-950/50'
                        : 'border-white/10 bg-white/5 hover:border-white/20 hover:bg-white/10'">
                        <div class="flex items-start gap-3">
                            <div class="w-2 h-2 rounded-full mt-1.5 flex-shrink-0"
                                class.bind="selectedProduct === product.key ? 'bg-blue-400' : 'bg-gray-600'"></div>
                            <div>
                                <p class="text-white text-sm font-medium">${product.name}</p>
                                <p class="text-gray-400 text-xs mt-0.5">${product.description}</p>
                                <p if.bind="!isDeviceSupported(product.key)" class="text-amber-400/70 text-xs mt-1">Not
                                    supported by ${selectedBoard.name}</p>
                            </div>
                        </div>
                    </button>
                </div>

                <!-- ─── Step 3: Version ─────────────────────────────────── -->
                <div if.bind="step === 3" class="space-y-4">
                    <p class="text-gray-300 text-sm">Select the version to install.</p>

                    <div if.bind="versionBusy" class="flex items-center gap-3 text-blue-300 text-sm py-4">
                        <svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4">
                            </circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8H4z"></path>
                        </svg>
                        ${versionStatus}
                    </div>

                    <div if.bind="!versionBusy && versions.length > 0">
                        <select value.bind="selectedVersion"
                            class="w-full bg-gray-800 border border-white/10 rounded-xl px-4 py-2.5 text-white text-sm focus:outline-none focus:border-blue-500">
                            <option repeat.for="v of versions" value.bind="v">${v}</option>
                        </select>
                        <p class="text-gray-500 text-xs mt-2">
                            The repository will be cloned and checked out at the chosen tag.
                        </p>
                    </div>

                    <div if.bind="!versionBusy && versions.length === 0 && !versionError"
                        class="text-gray-400 text-sm py-2">No version tags found in the repository.</div>

                    <div if.bind="versionError"
                        class="bg-red-900/30 border border-red-500/30 rounded-xl p-3 text-red-300 text-sm">
                        ${versionError}
                    </div>

                    <div if.bind="finishError"
                        class="bg-red-900/30 border border-red-500/30 rounded-xl p-3 text-red-300 text-sm">
                        Setup failed: ${finishError}
                    </div>
                </div>

            </div>

        </div>
        <!-- Footer -->
        <div class="flex items-center justify-between px-6 py-4 border-t border-white/10">
            <button click.trigger="cancel()" class="px-4 py-2 text-gray-400 hover:text-white text-sm transition-colors">
                Cancel
            </button>
            <div class="flex gap-3">
                <button if.bind="step > 0" click.trigger="goBack()"
                    class="px-4 py-2 bg-white/10 hover:bg-white/20 border border-white/10 rounded-lg text-white text-sm transition-colors">
                    Back
                </button>
                <button click.trigger="goNext()" disabled.bind="!canGoNext || finishing || cliInstalling || versionBusy"
                    class="px-5 py-2 bg-blue-600 hover:bg-blue-500 disabled:bg-gray-700 disabled:text-gray-500 rounded-lg text-white text-sm font-semibold transition-colors">
                    ${finishing ? 'Setting up...' : (step === 3 ? 'Finish' : 'Next')}
                </button>
            </div>
        </div>

    </div>
</template>