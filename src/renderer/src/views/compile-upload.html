<template>
    <import from="../components/app-layout"></import>
    <import from="../components/nav-bar"></import>
    <import from="../components/serial-monitor"></import>

    <app-layout title="Compile &amp; Upload">
        <div class="max-w-3xl mx-auto space-y-6">
            <!-- Status message -->
            <div class="text-center space-y-2">
                <p class="text-gray-700">${statusMessage}</p>

                <p if.bind="successMessage" class="text-lg font-semibold text-green-700">${successMessage}</p>
                <p if.bind="successDetail" class="text-gray-600">${successDetail}</p>
            </div>

            <!-- Action buttons -->
            <div class="flex justify-center gap-4">
                <button if.bind="!isRunning" click.trigger="startCompileUpload()"
                    class="e-btn e-primary px-8 py-3 text-lg">
                    ${uploadDone ? 'Load Again' : 'Load'}
                </button>

                <button if.bind="uploadDone" click.trigger="backupConfig()" class="e-btn e-outline px-6 py-3">
                    Backup Config Files
                </button>
            </div>

            <!-- Progress -->
            <div if.bind="isRunning" class="space-y-2">
                <div class="flex items-center gap-3">
                    <div class="w-4 h-4 border-2 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
                    <span class="text-sm text-gray-600">${progressPhase}</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div class="bg-blue-600 h-2 rounded-full transition-all" style="width: ${progressPercent}%"></div>
                </div>
            </div>

            <!-- Log output -->
            <div class="space-y-2">
                <h3 class="font-semibold text-gray-800">Output</h3>
                <div ref="logContainer"
                    class="bg-gray-900 text-gray-100 font-mono text-xs p-4 rounded-lg h-64 overflow-y-auto whitespace-pre-wrap">
                    ${logOutput}
                </div>
            </div>

            <div if.bind="error" class="bg-red-50 border border-red-200 rounded-lg p-4">
                <p class="text-red-700">${error}</p>
            </div>

            <!-- Serial monitor (shown after successful upload) -->
            <serial-monitor if.bind="showMonitor"></serial-monitor>
        </div>

        <nav-bar au-slot="footer" show-next.bind="uploadDone" next-text="Close" show-monitor.bind="uploadDone"
            back-action.bind="() => goBack()" next-action.bind="() => closeApp()"
            monitor-action.bind="() => toggleMonitor()">
        </nav-bar>
    </app-layout>
</template>